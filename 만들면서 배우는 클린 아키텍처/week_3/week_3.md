#### 해당 정리 내용은 `만들면서 배우는 클린아키텍처`도서를 읽고 정리한 내용입니다.

## 7. 아키텍처 요소 테스트하기

테스트 피라미드는 위에서 부터 `시스템 테스트`, `통합 테스트`, `단위 테스트`로 구성되어있다. <br>
테스트 피라미드에 따르면 비용이 많이 드는 테스트는 지양하고 비용이 적게 드는 테스트를 많이 만들어야 한다.

<b>테스트 케이스</b>의 기본 전제는 만드는 비용이 적고, 유지보수하기 쉽고, 빨리 실행되고, 안정적인 작은 크기의 테스트들에 대해 높은 커버리지를 유지해야 한다는 것이다.

주의해야할 점은 여러개의 단위와 단위를 넘는 경계, 아키텍처 경계, 시스템 경계를 결합하는 테스트는 만드는 비용이 더 비싸지고
실행이 더느려지며 깨지기 더 쉬워진다.

테스트 피라미드는 테스트가 비싸질수록 테스트의 커버리지 목표는 낮게 잡아야 한다는 것을 보여준다,
그렇지 않다면 새로운 기능을 만드는 것보다 테스트를 만드는 데 시간을 더 쓰게 되기 때문이다.

---

#### ✔️ 단위 테스트
> 단위테스트는 피라미드의 토대에 해당된다. 일반적으로 하나의 클래스를 인스턴스화하고 해당 클래스의 인터페이스를 통해
> 기능들을 테스트한다. 만약 테스트중인 클래스가 다른 클래스에 의존한다면 의존되는 클래스들은 인스턴스화하지
> 않고 테스트하는 동안 필요한 작업들을 흉내 내는 목(mock)으로 대체한다.

<br>

#### ✔️ 통합테스트
> 통합테스트는 연결된 여러 유닛을 인스턴스화하고 시작점이 되는 클래스의 인터페이스로 데이터를 보낸 후 유닛들의 네트워크가 기대한 대로 잘 동작하는지 검증한다.

<br>

#### ✔️ 시스템 테스트
> 시스템 테스트는 애플리케이션을 구성하는 모든 객체 네트워크를 가동시켜 특정 유스케이스가 전 계층에서 잘 동작하는지 검증한다.

<br><br>

---

### 테스트 하기전 GWT란 

`given` - 준비단계로 테스트에 사용하는 변수, 입력 값 등을 정의하거나 Mock객체를 정의하는 구분도 given에 포함된다.

`when` - 실제로 액션을 하는 테스트를 실행하는 과정이다. 아래와 같이 실제 서비스 메서드를 실행하는 과정을 의미
> boolean check = checkService.check(xx);

`then` - 실제 테스트된 결과를 검증하는 과정이다, 예상한값과 실제로 나온값을 검증하는 부분.

---

### 단위 테스트로 도메인 엔티티 테스트하기 ( P.82 )

도메인 엔티티의 행동의 대한 테스트는 다른 클래스에 거의 의존하지 않기 때문에 다른 종류의 테스트는 필요하지 않는다.

---

### 단위 테스트로 유스케이스 테스트하기 ( P.85 )

테스트의 가독성을 높이기 위해 행동-주도 개발에서 일반적으로 사용되는 방식으로 `given`/`when`/`then`섹션으로 나눴다.

실제 업무에서 유스케이스를 테스트 하기위해서는 해당 서비스안에 여러가지 Service or Repositry들이 포함되어있다
해당 객체들은 Mockito라이브러리를 이용하여 목 객체를 생성할 수 있다.

모든 동작을 검증하는 대신 중요한 핵심만 골라 집중해서 테스트하는것이 좋다. 만약 모든 동작을 검증하려고 한다면 클래스가 조금이라도
바뀔 때마다 테스트를 변경해야 한다. 이는 테스트의 가치를 떨어뜨리는 일이다.

---

### 통합 테스트로 웹 어댑터 테스트하기 ( P.86 )

웹어댑터는 다음과 같은 동작을 한다.
 - JSON문자열 등의 형태로 HTTP를 통해 입력을 받는다.
 - 입력에 대한 유효성 검증을 한다.
 - 유스케이스에서 아용할 수 있는 포맷으로 매핑한다
 - 유스케이스에 전달한다
 - 유스케이스의 결과를 JSON으로 매핑하고 HTTP 응답을 통해 클라이언트에 반환했다.

웹 어댑터에서는 해당 요청을 보내고, 응답의 상태를 검증하고, 모킹한 유스케이스가 잘 호출됐는지 검증한다.

그렇다면 웹 어댑터 테스트를 왜 단위테스트가 아닌 통합테스트라고 부를까

해당 테스트에서는 하나의 웹 컨트롤러 클래스만 테스트한것처럼 보이지만 실제로 뒤에서는 @WebMvcTest 어노테이션을 통해
스프링이 특정 요청 경로, 자바와 JSON간의 매핑, HTTP 입력검증 등에 필요한 전체 객체 네트워크를 인스턴스화하도록 만든다.

그리고 해당 테스트에서는 웹컨트롤러가 이 네트워크의 일부로서 잘 동작하는지 검증한다.

---

### 통합 테스트로 영속성 어댑터 ( P.89 )

웹 어댑터 테스트하기와 비슷한 이유로 영속성 어댑터의 테스트에는 단위 테스트보다는 통합 테스트를 적용하는것이 합리적이다.
단순히 어댑터의 로직만 검증하고 싶은 게 아니라 데이터베이스 매핑도 검증하고 싶기 때문이다.

영속성 어댑터에서의 통합테스트를 하기 위해서는 `@DataJpaTest`어노테이션을 통해 스프링 데이터 리포지토리들을 포함해서 데이터베이스 접근에
필요한 객체 네트워크를 인스턴스화 해야 한다고 스프링에게 알려준다.

추가로 `@Import`를 사용하요 특정 객체가 해당 네트워크에 추가됐다는 것을 명확하게 표현할 수 있다.

다만 주의해야할 점은 해당 테스트는 Mock 데이터를 사용한것이 아닌 실제 데이터베이스와 연동된다.
따라서 SQL구문의 오류나 테이블과 객체간의 매핑에러등으로 문제가 생길 확률이 높다.

이러한 문제의 해결방법으로 스프링에서는 기본적으로 `인메모리` 데이터베이스를 테스트에서 사용한다.
아무것도 설정할 필요 없이 곧바로 테스트할 수 있으므로 아주 실용적이다.

다만 해당 방식도 프로덕션 환경에서는 인메모리 DB를 사용하지 않는 경우가 많기 때문에 인메모리 데이터베이스에서 테스트가
완벽하게 통과했더라고 실제 DB에서도 문제가 생길 가능성은 있다.

하지만 이 방식도 문제가 생길수 있다고 한다. `TestContainers`같은 라이브러리는 필요한 데이터베이스를 도커 컨테이너에 띄울 수 있어 좋다고 한다.

---

### 시스템 테스트로 주요 경로 테스트하기 ( P.91 )

피라미드의 최상단에있는 시스템 테스트는 전체 애플리케이션을 띄우고 API를 통해 요청을 보내고 모든 계층이
조화롭게 잘 동작하는지 검증한다.

`@SpringBootTest` 어노테이션은 스프링이 애플리케이션을 구성하는 모든 객체 네트워크를 띄우게 한다.
(또한 랜덤 포트로 해당 애플리케이션을 띄우도록 설정되어있다.)

해당 테스트에서는 `MockMVC` 상요이 아는 `TestRestTemplate`를 사용하여 작성하였다. 다음과 같이 구성하면
테스트를 프로덕션 환경에 조금 더 가깝게 만들 수 있다.

- 시스템 테스트에서는 단위테스트나 통합테스트가 할 수 있는 것보다 훨씬 더 실제 사용자를 잘 흉내내기 때문에 사용자 관점에서 애플리케이션을 검증할 수 있다.
- 적절한 어휘를 사용하면 훨씬 더 쉬워진다,
- 시스템 테스트는 여러 개의 유스케이스를 결합해서 시나리오를 만들 때 더 빛이 난다. 각 시나리오는 사용자가 애플리케이션을 사용하면서 거쳐갈 특정 경로를 의미한다.
- 시스템 테스트를 통해 중요한 시나리오들이 커버된다면 최신 변경사항들이 애플리케이션을 망가뜨리지 않았음을 가정할 수 있고, 배포될 준비가 됐다는 확신을 가질 수 있다.

---

### 그렇다면 테스트를 얼마나 해야 충분할까

그렇다면 얼마나 테스트를 해야 충분할까??

해당 도서에서는 `라인커러리지`는 테스트 성공을 측정하는 데 있어서는 잘못된지표라고 설명한다.
코드의 중요한 부분이 전혀 커버되지 않을 수 있기 때문에 100%를 제외한 어떤 목표도 완전히 무의미하다.

이 책에서는 얼마나 마음 편하게 소프트웨어를 배포할 수 있느냐를 테스트의 성공 기준으로 삼으면 된다고 생각한다고 나와있다.
테스트를 신뢰하고 더 자주 배포할수록 테스트를 더 신뢰할 수 있다. 일년에 한두번만 배포한다면 해당 테스트를 신뢰할 수 없을 것이다.

처음에는 몇번의 도약이 필요하지만 프로덕션의 버그를 수정하고 이로부터 배우는것을 우선순위로 삼으면 제대로 가고있는 것이다.<br>
버그에 대해서는  해당 케이스를 커버할 수있는 테스트를 추가하고 시간이 지나면 이 작업들이 배포할때 마음을 편하게 해줄것이고,
남겨둔 기록은 시간이 지날수록 상황이 개선되고 있음을 증명해줄 것이다.

#### ✔️ 헥사고날 아케틱처에서 사용하는 전략은 다음과 같다
 - 도메인 엔티티를 구현할 때는 단위 테스트로 커버하자
 - 유스케이스를 구현할 때는 단위 테스트로 커버하자.
 - 어댑터는 통합테스트로 커버하자
 - 사용자가 취할 수 있는 중요 애플리케이션 경로는 시스템 테스트로 커버하자.



