
## Nginx 고성능 부하분산

오늘날에는 높은 성능과 가용성이 필요하다, 이를 위해 같은 시스템을 여러개로 운영하고 부하를 각 시스템으로 분산한다.
 
`nginx`와 같은 프록시 또는 `로드 밸런서`서버는 업스트림 서버의 문제를 감지할 수 있어야 하며, 문제 발견 시 트래픽 전송을 중지할 수 있어야한다. 그렇지 않다면 사용자가 서버의 응답을 기다리다가 결국 타임아웃오류를 보게된다.

해당 문제를 찾기위해서 프록시 서버와 로드밸런서 서버가 업스트림 서버의 상태를 확인하도록 하는 방법이 있다.

`nginx` 에서는 `패시브 방식`을 제공하며 `nginx 플러스`에서는 추가로 `액티브 방식`을 제공한다.

> #### 액티브 방식
> - 로드 밸런서 장비가 스스로 업스트림 서버와 주기적으로 연결을 시도하거나 요청을 보내 서버 응답에 문제가 없는지 확인하는 방식.
>   업스트림 서버의 상태를 사용자 요청을 받기전에 미리 확인해야 할 때 유용하다
> 
> #### 패시브 방식
> 
>  - 사용자의 요청을 로드밸런서가 받은 시점에 업스트림 서버와의 연결이나 응답을 확인하는 방식, 업스트림 서버의 부하를 늘리지 않으면서 상태를 확인하려면
>    패시브 방식을 사용하는 편이 좋다.


## HTTP 부하분산, TCP 부하분산 

### 🌟 HTTP 부하분산
> HTTP부하 분산은 nginx의 upstream 블록과 http 모듈을 이용하여 서버간에 부하를 분산한다.

```shell
# 다음과 같이 설정하면 해당 위에 서버 2대를 통해 연결하며, 위 2대와 연결이 불가능할 경우 backup 서버를 사용한다.
# weight의 기본값은 1이며 해당 값을 생략할 수 있다, weight 1, 2를 다음과 같이주면 
# `test.sample.com`서버가 `10.10.10.10`서버에 비해 2배 많은 요청을 받는다.

upstream backend {
    server 10.10.10.10:80        weight=1;
    server test.sample.com:80    weight=2;
    server backup.sample.com:80  backup;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

부하분산을 위한 목적지 정보는 유닉스 소켓, IP주소, DNS 혹은 다음 값들의 조합으로 구성한다.
해당 값들을 매개변수와 함께 지정하면 추가 제어방법을 제공한다. 매개변수들을 통해
분산 알고리즘에 가중치를 적용하거나 서버가 어떤 상태인지 알려주며, 서버 가용 여부를 판단하는 방법을 포함한다.



### 🌟 TCP 부하분산