
# 1. 카프카 시작하기

---

## 발행/구독 메시지 전달
> 발행/구독 메시지 전달 패턴의 특징은 전송자가 데이터를 보낼 때 직접 수신자로 보내지 않는다는 것이다. <br>
> 대신 전송자는 어떤 형태로든 메시지를 분류해서 보내고, 수신자는 이렇게 분류된 메시지를 수신하게 된다.
> 
> 발행/구독 시스템에는 대게 발행된 메시지를 전달받고 중계해주는 중간 지점 역할을 하는 브로커가 있다.


---

### 초기의 발행/구독 시스템

발행/구독 패턴은 초기에는 데이터가 필요한 하나의 서버에 데이터를 전송하여 하나의 애플리케이션 서버에서 해당 데이터를 기준으로
동작하게 만들었다. 하지만 시간이 지나면서 서비스는 커지게 되고 다양한 목적으로 데이트럴 활용하는 많은 애플리케이션들이
추가될 수 있다. 결과적으로는 아래 이미지 처럼 구성하게 된다.

![img.png](img.png)

딱봐도 해당 방식은 개선할 필요가 있다고 보여진다.

다음과 같은 방법을 해결하기 위해 나온것이 해당 값을 관리하는 하나의 애플리케이션 서버를 제공하고, 해당 애플리케이션 서버로
값들이 필요로하는 어떤 시스템이든 질의를 할 수 있도록 해주는 것이다.


![img_1.png](img_1.png)

---

### 개별 메시지 큐 시스템 

위에 나온 구조 외에도 `로그 메시지에 대한 발행/구독`, `사용자 추적 발행/구독`에 대한 내용이 추가 되어야 한다면
아래와 같은 시스템 구성이 나오게 된다.

![img_2.png](img_2.png)

위 사진을 보면 비지니스가 확장됨에 따라 `지표값 발행/구독`, `로그 메시지 발행/구독`, `사용자 추적 발행/구독`와 같이 
발행/구독 서버가 늘어나면서 관리포인트가 늘어나게 되고, 데이터를 전달하기 위해 중복코드가 발생하며, 버그가 발생하게 된다면
다수의 큐에 대한 시스템 관리가 이뤄져야 한다.

이러한 문제를 해결하기 위해서는 중앙에서 데이터의 발행/구독을 처리하는 중앙 집중화된 시스템이 필요 하게 된다.

---

## 카프카 

> 카프카는 위에서 나온 문제를 해결하기 위해 고안된 발행/구독 시스템이다.<br>
> 카프카는 `분산 커밋 로그` or `분산 스트리밍 플랫폼` 이라고도 불린다.<br>
> 
> 카프카는 파일시스템이나 데이터베이스 처럼 모든 트랜잭션 기록을 지속성있게 보존함으로써 일관성있게 복구할 수 있도록 보관하며, 확장시
> 성능을 향상시키고 실패가 발생하더라도 데이터 사용에는 문제가 없도록 시스템 안에서 분산시켜 저장할 수 있다


### 메시지와 배치

카프카에서 데이터의 기본 단위는 `메시지`이다. 우리가 흔하게 사용하는 데이터베이스의 `row` or `레코드`와 비슷하다고 볼 수 있다.

`메시지` 
 - 단순히 바이트의 배열이기 때문에 특정한 형식이나 의미가 없다.

`키`
 - 메타 데이터를 포함할 수 있다. 키역시 특별한 의미가 없는 단순한 바이트의 배열이다.
 - 메시지를 저장할 파티션을 결정하기 위해 사용된다. 간단한 방법으로는 키 값에서 해시값을 생성한 뒤 이 값을 토픽의 파티션 수로 나눴을떄 나오는 나머지 값에 해당하는 파티션에 메시지를 저장하게 된다. 이러면 같은 키값을 갖는 메시지들은 파티션의 갯수가 변경되지 않는한 항상 같은 파티션에 저장된다.

카프카는 효율성을 위해 메시지를 `배치` 단위로 저장한다. 
배치는 그냥 같은 토픽의 파티션에 쓰여지는 메시지들의 집합일 뿐이다. 

메시지를 쓸때마다 네트워크 신호가 오가는 것은 막대한 오버헤드를 발생하게 된다. 따라서 메시지를 배치 단위로 모아서
쓰면 오버헤드를 줄일 수 있다. 

물론 이것은 지연과 처리량사이에 트레이드 오프를 발생시킨다. 이말은 즉 배치 크기가 커질수록 시간당
처리되는 메시지의 수는 늘어나겠지만, 메시지가 전달되는데 걸리는 시간은 늘어나게 된다.

배치는 이러한 경우때문에 더 효율적인 데이터 전송과 저장을 위해 약간의 처리능력을 들여서 압축되는 경우가 많다.

---


### 스키마

카프카는 단순한 바이트 배열일 뿐이지만 전달하는 내용을 이해하기 쉽도록 일정훈 구조를 부여하는 것이 권장된다. 이것을 스키마라고 한다.

각 애플리케이션의 필요에 따라 사용 가능한 스키마가 여러가지가 있다. `JSON`, `XML` 이 기본적으로 많이 사용되나 해당 방식들은
버전간의 호환성 유지 기능이 떨어진다.

많은 카프카 개발자들은 아파치 `에이브로(Avro)` 를 선호한다. 

- 조밀한 직렬화 형식을 제공한다.
- 메시지 보넻와 스키마를 분리하기 때문에 스키마가 변경되더라도 코드를 생성할 필요가 없다.
- 강력한 데이터 타이핑과 스키마 변경에 따른 상위 호환성, 하위호환성을 지원한다.


