# 20장 리다이렉션과 부하 균형 

---

웹에서 HTTP는 혼자가 아니다. HTTP메시지의 데이터는 많은 프로토콜에 의해 통제된다. 
<br>
HTTP가 고려하는 것은 출발지와 목적지 뿐이지만 웹 세계에서는 단순하지는 않다.

리다이렉션 기술은 보통 메시지가 프록시, 캐시, 서버 팜의 특정 웹 서버중 어디에서 끝나는지 판단하기 위해 사용한다.

리다이렉션 기법으로는 다음과 같다

 - HTTP 리다이렉션
 - DNS 리다이렉션
 - 임의 캐스트 라우팅
 - 정책 라우팅
 - 아이피 맥 포워딩
 - 아이피 주소 포워딩
 - 웹 캐시 조직 프로토콜(WCCP)
 - 인터캐시 커뮤니케이션 프로토콜(ICP)
 - 하이퍼텍스트 캐싱 프로토콜 (HTCP)
 - 네트워크 요소 제어 프로토콜(NECP)
 - 캐시 배열 라우팅 프로토콜 (CARP)
 - 웹 프록시 자동발견 프로토콜 (WPAD)

---

## 왜 리다이렉트인가?

HTTP 애플리케이션은 `지연 최소화`, `네트워크 대역폭 절약`, `신뢰할 수 있는 HTTP 트랜잭션의 수행` 다음 세가지를 원하기 떄문에

웹 컨텐츠는 흔히 여려 장소에 배포하게 된다. 이렇게 하면 한곳에서 장애가 발생할 경우 다른 애플리케이션 서버를 이용할 수 있기 때문에
신뢰성이 개선된다.

또한 클라이언트가 보다 가까운 장소에 있는 애플리케이션 서버에 접근할 수 있기 때문에 응답시간도 줄어든다. 목적지 서버 또한 분산
되었기 때문에 네트워크 혼잡도 줄어들게 된다. 

따라서 리다이렉션이 최적의 분산된 컨텐츠를 찾는 것을 도와주는 기법의 집합이라고 볼 수 있다.

---

## 리다이렉트 할 곳

클라이언트가 HTTP 요청을 보낸다는 관점에서 바라본다면, 서버, 프락시, 캐시, 게이트웨이는 클라이언트에게 있어 모두 
서버라고 할 수 있다. 서버, 프락시, 캐시, 게이트웨이가 모두 공통적으로 서버의 특성을 갖고 있기 때문에 많은 리다이렉션 기법이 그들 모두에서 동작한다.

다만 어떤 리다이렉션 기술들은 특정 종류의 종단만을 위해 특별히 설계되어 일반적인 적용이 불가능하다.

웹서버는 IP별로 요청을 다룬다. 똑같이 복제된 서버들로 요청을 분산한다는 것은 같은 URL에 대해서 여러
곳에서 온 요청들을 각각 최적의 웹 서버로 보내겠다는 것을 의미한다.

프록시는 프로토콜별로 요청을 다룬다. 이상적으로 프록시 이웃의 모든 HTTP트래픽은 프록시를 거쳐야 한다.
프록시로의 리다이렉트는 주로 진입로의 트래픽을 근처에 있는 지름길로 빨아들이는 것과 같다.

---

## 리다이렉션 프로토콜의 개요

리다이렉션의 목표는 HTTP 메시지를 웹 서버로 빠르게 보내는 것이다. HTTP 메시지가 나아가는 방향은
메시지가 오고, 거쳐가고, 향하는 HTTP 애플리케이션과 라우팅 장치에 영향을 받는다. 

- 사용자는 브라우저 클라이언트 메시지를 프록시 서버로 보내도록 설정할 수 있다.
- DNS분석자는 메시지의 주소를 지정할 때 사용될 아이피 주소를 선택한다.
- 웹서버는 HTTP 리다이렉트를 이용하여 요청이 다른 웹 서버로 가도록 할 수 있다.


브라우저 설정, DNS, TCP/IP 라우팅, HTTP는 모두 메시지를 리다이렉트 하는 메커니즘을 제공한다.

리다이렉션 방법들은 P.524에 표로 정리되어있다.

---

## 일반적인 리다이렉션 방법

### HTTP 리다이렉션 

웹 서버들은 다른곳에 요청을 보내보라고 말해주는 짧은 리다이렉트 메시지릴 클라이언트에게 돌려줄 수 있다. 
몇몇 웹사이트들은 HTTP 리다이렉션을 통해 부하를 분산하기도 한다.

요청을 처리하는 서버는 가용하고있는 서버중 가장 부하가 적은 서버를 찾아 리다이렉트 한다.

리다이렉트 요청은 기존 요청과 다른 값을 반환한다.

기존 값 
```http request
GET /sample.html HTTP/1.0
Host: www.sample.com
User-Agent: xxx
```

해당 응답은 200과 함꼐 페이지를 돌려준다. 하지만 리다이렉트는 아래와 같은 응답을 한다

```http request
HTTP/1.0 302 Redirect
Server: xx
Location: http://www.sample2.com
```

위와 같이 응답을 받으면 해당 응답을 바탕으로 다시한번 http://www.sample2.com으로 요청을 리다이렉트 한다.

HTTP 리다이렉션은 서버로 향하는 요청의 방향을 변경할 수 있지만, 다음과 같은 몇가지 단점이 있다.

1. 어떠한 서버로 리다이렉트할지 결정하겨면 원 서버는 상당히 많은 처리를 해야 한다. 때로는 거의 페이지 자체를 제공할 때 필요한 것과 거의 같은 양의 처리가 필요하다.
2. 페이지에 접근할 때마다 두번의 왕복이 필요하기 떄문에 사용자가 더 오래 기다리게 된다.
3. 리다이렉트 서버가 장애가 난다면 사이트도 고장나게 된다.

이러한 약점 떄문에 HTTP 리다이렉션은 보통 몇몇 다른 리다이렉션 기법과 함께 조합하여 사용된다.

---

### DNS 리다이렉션 

가장 쉬운 DNS 결정 알고리즘은 단순한 라운드 로빈이다.

#### DNS 라운드 로빈

DNS라운드로빈은 가장 흔한 동시에 가장 간단한 리다이렉션 기법이다. DNS 라운드 로빈은 웹서버 팜 전체에 대한
부하의 균형을 유지하기 위해 DNS 호스트 명 분석 기능을 사용한다. 순수 부하 균형 전략이며, 서버에 대한
클라이언트의 상대적인 위치나 서버의 현재 스트레스를 고려하지 않는다.

#### 다중 주소와 라운드 로빈 주소 순환 
대부분의 DNS 클라이언트는 그냥 다중 주소 집합의 첫 번째 주소를 사용한다. 

부하 균형을 위해, 대부분의 DNS 서버는 룩업이 끝났을 때마다 주소를 순환시킨다.
이 주소 순환을 DNS 라운드 로빈 이라고 부른다.

P.530 예제 처럼 순환을 돌면서 다음에 있는 첫번째 주소를 반환한다.

---

#### 부하 균형을 위한 DNS 라운드 로빈 

대부분의 DNS 클라이언트는 그냥 첫 번째 주소를 사용하기 때문에, DNS 순환은 서버들 간의 부하 균형을 유지해준다.

만약 DNS가 주소를 순환시키지 않는다면, 대부분의 클라이언트가 목록의 첫 번째 서버를 선택할 것이고, 첫번째 서버가
대부분의 부하를 받게 된다.


#### DNS 캐싱의 효과 

DNS 주소 순환은 부하를 순환시킨다 서버에 대한 각 DNS 룩업은 서버주소를 다른 순서로 가져오기 때문이다.

그러나 해당 부하균형은 완벽하지 않은데, DNS 룩업의 결과는 애플리케이션, 운영체제, 몇몇 기초적인 자식 DNS 서버에
의해 기억되어 재사용 될 수 있기 때문이다.

호스트 하나에 대해 한 번의 DNS 룩업을 수행한 뒤 그 주소를 몇번이고 다시 사용한다. 이렇게 하면 DNS 룩업의 비용을
줄일 수 있을 뿐 아니라, 같은 클라이언트와 계속 대화하는 것을 선호하는 서버들도 있다.


#### 다른 DNS 기반 리다이렉션 알고리즘

몇몇 향상된 DNS 서버는 주소의 순서를 결정하기 위해 다른 기법을 사용하기도 한다.

- 부하 균형 알고리즘
  > 웹 서버의 로드를 추적하고 가장 로드가 적은 웹 서버를 목록의 가장 위에 놓는다.
- 근접 라우팅 알고리즘
  > 서버들의 팜이 지리적으로 분산되어있는 경우, DNS 서버는 사용자를 기반하여 근처의 웹 서버로 보내는 시도를 할 수 있다.
- 결함 마스킹 알고리즘
  > DNS 서버는 네트워크의 건강 상태를 모니터링하고 요청을 정전이나 기타 장애를 피해서 라우팅 할 수 있다.
  
--- 

### 임의 캐스트 어드레싱 

임의 캐스트 어드레싱에서, 여러 지리적으로 흩어진 웹 서버들은 정확히 같은 아이피 주소를 갖고 클라이언트의 요청을 클라이언트에서
가장 가까운 서버로 보내주기 위해 최단거리 라우팅 능력에 의지한다.

해당 방법의 동작 방식은 각 웹서버에게 자신을 인접한 백본 라우터를 향하는 라우터라고 광고하는 것이다. 
백본 라우터가 임의 캐스트 주소를 목적지로 하는 패킷을 받았을 때 그것은 그 아이피 주소ㅓ를
받아들일 수 있는 가장 가까운 라우터를 찾는다. 그리고 그 백본 라우터는 해당 서버에게 패킷을 보낸다.

> 다만 해당 도서 작성 시점에는 실헙적인 기법이다.
> 
> 적절하게 처리되지 않는다면 라우팅 누수가 발생할 수 있다.

---

### 아이피 맥 포워딩 

이더넷 네트워크에서 HTTP 메시지는 주소가 붙은 데이터 패킷의 형태로 보내진다. 

