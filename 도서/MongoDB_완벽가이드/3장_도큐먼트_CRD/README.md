# 도큐먼트 생성, 갱신, 삭제

---

## 도큐먼트 삽입 

앞선 내용처럼 insertOne과 insertMany를 통해 데이터를 삽입할 수 있다.

`insertOne` - 단건 등록 
`insertMany` - 벌크 삽입 

insertMany는 단일 컬렉션에 여러개의 데이터를 삽입할 때 유용하다. 
다만 한번에 삽입할 수 있는 데이터 크기는 48메가바이트 까지다.

insertMany를 통한 삽입시 정렬 연산을 선택했는지 비정렬 연산을 선택했는지에 따라 동작이 달라진다.

정렬되지 않은 삽입을 하였다면, 일부 isnert도중 오류가 발생하더라도 오류를 발생시키지 않고 모든 도큐먼트
삽입을 시도한다.

몽고 디비에서는 또한 대량 쓰기 API를 지원한다.(https://docs.mongodb.org/manual/core/flash-write-propertie4s)

---

### 삽입 유효성 검사

몽고 DB는 삽입된 데이터에 최소한의 검사를 수행한다. _id필드가 존재 하지 않으면 새로 추가하고 도큐먼트의 크기가
16메가 바이트보다 작은지 확인한다. 크기제한을 통해 나쁜 스키마 설계를 제한하고 일관된 성능을 보장한다.

최소한의 검사를 하는 이유는 유효하지 않은 데이터가 입력되기 쉽기때문이다 그러므로 애플리케이션 서버와 같이
신뢰성 있는 소스만 데이터베이스에 연결해야한다.

---


### 삽입

몽고DB 3.0 이전 버전에서는 주로 `insert`를 사용하였지만 몽고 3.0이상에서는 새로운 API를 제공하였다.

몽고DB 3.2에서는 셸도 해당 API를 지원한다. 이것이 insertOne과 insertMany이며 이뿐만 아니라 여러가지 방법ㄷ즐을 포함한다.

---

## 도큐먼트 삭제

삭제하기위해서는 `deleteOne`과 `deleteMany`를 제공한다. 두 메서드 모드 필터 도큐먼트를 첫번째로 사용한다.

만약 _id가 4인 값을 삭제하기위해서는 아래와 같이 실행한다.

```javascript
$ db.studies.deleteOne({"_id" : 4}) 
```

deleteOne을 이용하여 _id에 해당하는 값을 삭제하였으나 만약 삭제 조건에 해당하는 도큐먼트가 여러개라면
가장 먼저 발견되는 도큐먼트가 삭제된다. 

몽고DB 3.0 에서는 remove를 주로 사용하였으나 이후 버전에서는 deleteOne과 deleteMany를 지원한다.
애플리케이션개발시에는 remove가 아닌 deleteOne과 deleteMany를 사용하면 좋다.

### Drop

deleteMany를 사용하면 컬렉션의 모든 도큐먼트를 삭제한다. 일반적으로 도큐먼트를 제거하는것을 빠르다.
다만 컬렉션 자체를 삭제하기 위해서는 `drop`을 사용하는 편이 더 빠르다 

데이터는 한번 삭제하면 영원히 사라지게되기 때문에 백업된 데이터를 복구하는 방법외에는 데이터를 복구하는 방법은 없다.

---

## 도큐먼트 갱신 

도큐먼트가 한번 저장된 이후에 해당 도큐먼트를 업데이트 하기 위해서는 `updateOne`, `updateMany`, `replaceOne`과 같은
갱신 메서드를 사용한다. 

updateOne, updateMany는 수정하고자 하는 도큐먼트를 첫번쨰 매개변수로 사용하며, 변경하고자 하는 수정 도큐먼트를
두번째 매개변수로 사용한다.

갱신은 원자적으로 이뤄지며 동시 발생시 가장 먼저 서버에 도착한 요청이 적용된 다음 이후 작업이 진행된다. 

따라서 여러개의 요청이 동시에 접근되어도 결국 마지막에 도착한 요청이 승리자가 되므로 도큐먼트는 변질 없이 안전하게 처리된다.

### 도큐먼트 치환 

replaceOne은 도큐먼트를 새로운것으로 완전히 치환한다. 이는 대대적인 스키마 마이그레이션에 유용하다.
주위해야할 점은 치환하고자 하는 고유 도큐먼트를 찾을 시에는 _id와 같이 고유한 값을 사용하는 것이 좋다
만약 중복된 값을 가져와 치환하려고 한다면 오류를 반환한다.

### 갱신 연산자

부분 갱신에 주로 사용한다. $inc, $set, $unset등등을 제공한다. 
부분적으로 값을 증가시키거나, 새로운겂으로 대체, 삭제등을 진행할때 사용한다.

#### 증가와 감소

`$inc`는 주로 존재하는 키의 값을 변경하거나 새 키를 생성하는데 사용하며, 키가 없는 경우 새로운 키를 만들고 해당 값을 설정하고.
만약 키가 있다면 기존에 있던 값에 해당 값만큼 증가시킨다.

`$inc`는 `set`과 비슷하지만 숫자를 증감하기 위해 설계되었다. 해당 `$inc`는 int, long, double, decimal타입에만 사용 가능하다

만약 숫자가 아닌 값으로 증감을 시도하면 오류 매세지를 반환한다.

#### 배열 연산자 ($push)

이미 키가 존재하면 배열 끝에 요소를 추가하고, 존재하지 않는다면 새로운 배열을 생성하여 반환한다.
$push연산자를 사용할때 $slice 와 $sort등을 적용하여 특정 크기 이상으로 늘어나지 않게 할 수 있으며, 정렬도 할 수 있다 .


#### 배열을 집합으로 사용하기
`$ne`, `$addToSet`과 같이 집합 키워드를 사용하면 다양한 방식으로 데이터를 가져오거나 업데이트가 가능하다.

$addToSet을 사용하게 되면 중복을 피하여 사용가능 또한 고유 값을 여러개 추가하고 싶다면 $addToSet 과 $each를 활용한다.

#### 요소 제거 하기
배열에서 요소를 제거하는 방식은 다양하게 제공된다.

$pop가 그 예이며 $pop를 사용하면 배열의 양쪽 끝에서 요소를 제거한다.

```javascript
$ xxx.({}, {"$pop" : {"key": 1}}) 은 배열의 마지막 요소부터 제거
$ xxx.({}, {"$pop" : {"key": -1}}) 은 배열의 처음부터 요소를 제거한다. 
```

#때로는 배열 내 위치가 아닌 지정된 조건에 따라 제거한다. $pull은  주어진 조건에 맞는 배열 요소를 
제거하는데 사용된다.

#### 배열위 위치 기반 변경

배열내부에 있는 값을 변경하기 위해 배열 요소  및 요소의 위치를 알아내서 갱신하는 위치연산자 $를 제공한다.

도큐먼트 내부에 배열이 포함되 어있다면 {"$set" : {"comments.$.author": xx}} 와같이 $를 사용할 수 있다.

다만 주의해야할 점은 중복된값이 있다면 모두 변경하는것이 아니라 처음 발견된 요소를 갱신한다.

---

### 갱신 입력

갱신 입력은 특수한 형태를 갖는 갱신이다. 만약 갱신 조건에 맞는 도큐먼트가 없다면 쿼리 도큐먼트와 갱신도큐먼트를
합쳐 새로운 도큐먼트를 생서한다. 만약 조건에 맞는 도큐먼트가 있다면 일반적인 갱신을 수행한다.

갱신은 updateOne과 updateMany의 세번째 매개 변수 옵션으로 지정 가능하다 `{"upset" : true}`와 같이 설정 가능 .

경쟁상태로부터 안전하며, 한줄로 조건에 대한 처리 가능하여 더 빠르고 원자적이다. 

만약 도큐먼트가 생성될떄 한번 설정되고 이후 갱신하더라도 변하지 않아야 한다면 $setOnInsert를 사용하면 된다.



